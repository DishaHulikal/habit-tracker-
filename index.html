<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Habit Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    function HabitTracker() {
      const [habits, setHabits] = useState([
        { id: 1, name: 'Email', emoji: 'üìß', goal: 7 },
        { id: 2, name: 'Stats', emoji: 'üìä', goal: 5 },
        { id: 3, name: 'Udemy', emoji: 'üíº', goal: 5 },
        { id: 4, name: 'R Swirl', emoji: 'üìà', goal: 3 }
      ]);
      
      const [completions, setCompletions] = useState({});
      const [monthlyStats, setMonthlyStats] = useState({});
      const [newHabit, setNewHabit] = useState('');
      const [newEmoji, setNewEmoji] = useState('‚ú®');
      const [newGoal, setNewGoal] = useState(7);

      const getWeekDates = () => {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(today.setDate(diff));
        const week = [];
        for (let i = 0; i < 7; i++) {
          const date = new Date(monday);
          date.setDate(monday.getDate() + i);
          week.push(date);
        }
        return week;
      };

      const weekDates = getWeekDates();
      const formatDate = (date) => date.toISOString().split('T')[0];
      const getCurrentMonth = () => new Date().toLocaleString('default', { month: 'short', year: 'numeric' });

      useEffect(() => {
        const stored = localStorage.getItem('habitData');
        if (stored) {
          const data = JSON.parse(stored);
          setCompletions(data.completions || {});
          setMonthlyStats(data.monthlyStats || {});
          if (data.habits) setHabits(data.habits);
        }
      }, []);

      useEffect(() => {
        localStorage.setItem('habitData', JSON.stringify({ completions, monthlyStats, habits }));
      }, [completions, monthlyStats, habits]);

      const triggerConfetti = () => {
        confetti({ particleCount: 100, spread: 50, origin: { y: 0.8 }, colors: ['#5e7ce2', '#7d8ba8', '#50C878'] });
      };

      const toggleHabit = (habitId, date) => {
        const key = `${habitId}-${date}`;
        const newCompletions = { ...completions };
        const isTurningOn = !newCompletions[key];
        isTurningOn ? newCompletions[key] = true : delete newCompletions[key];
        setCompletions(newCompletions);
        updateMonthlyStats(habitId, newCompletions);
        if (isTurningOn) {
          const allDone = habits.every(h => h.id === habitId ? true : newCompletions[`${h.id}-${date}`]);
          if (allDone) triggerConfetti();
        }
      };

      const updateMonthlyStats = (habitId, newCompletions) => {
        const currentMonth = getCurrentMonth();
        const monthCompletions = Object.keys(newCompletions).filter(key => {
          if (!key.startsWith(`${habitId}-`)) return false;
          const date = key.split('-').slice(1).join('-');
          const checkDate = new Date(date);
          return checkDate.getMonth() === new Date().getMonth();
        }).length;
        setMonthlyStats(prev => ({ ...prev, [`${habitId}-${currentMonth}`]: monthCompletions }));
      };

      const isChecked = (habitId, date) => completions[`${habitId}-${date}`] || false;
      const getStreak = (habitId) => {
        let streak = 0;
        const today = new Date();
        for (let i = 0; i < 365; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() - i);
          if (isChecked(habitId, formatDate(date))) streak++;
          else break;
        }
        return streak;
      };

      return (
        <div className="min-h-screen p-2" style={{background: '#c9bdb4'}}>
          <div className="max-w-full mx-auto">
            {/* Shrunken Header */}
            <div className="mb-2 flex justify-between items-end px-1">
              <h1 className="text-xl font-bold" style={{fontFamily: 'cursive', color: '#7d8ba8'}}>Habits ‚òÖ</h1>
              <p className="text-[10px]" style={{color: '#8b7d73'}}>{weekDates[0].toLocaleDateString()}</p>
            </div>

            <div className="bg-white rounded-lg shadow p-2 mb-2 overflow-x-auto" style={{background: '#e8e2dd'}}>
              <table className="w-full text-xs">
                <thead>
                  <tr className="border-b border-[#d0c4bd]">
                    <th className="text-left py-1 px-1 font-bold text-[#7d8ba8]">Habit</th>
                    <th className="text-center py-1 px-1 text-[#7d8ba8]">Goal</th>
                    {['M','T','W','T','F','S','S'].map((day, idx) => (
                      <th key={idx} className="py-1 px-0.5 text-center text-[#7d8ba8]">
                        <div>{day}</div>
                        <div className="text-[9px] opacity-70">{weekDates[idx].getDate()}</div>
                      </th>
                    ))}
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {habits.map(habit => {
                    const weeklyCount = weekDates.filter(d => isChecked(habit.id, formatDate(d))).length;
                    return (
                      <tr key={habit.id} className="border-b border-[#d9cfc7]">
                        <td className="py-1.5 px-1 max-w-[80px]">
                          <div className="flex items-center gap-1 truncate">
                            <span>{habit.emoji}</span>
                            <span className="font-medium text-[#4a4a4a] truncate">{habit.name}</span>
                          </div>
                        </td>
                        <td className="text-center text-[10px] text-[#8b7d73]">{weeklyCount}/{habit.goal}</td>
                        {weekDates.map(date => {
                          const dateStr = formatDate(date);
                          const checked = isChecked(habit.id, dateStr);
                          return (
                            <td key={dateStr} className="p-0.5 text-center">
                              <button
                                onClick={() => toggleHabit(habit.id, dateStr)}
                                className="w-5 h-5 rounded border transition-all flex items-center justify-center mx-auto"
                                style={{
                                  background: checked ? '#5e7ce2' : 'white',
                                  borderColor: checked ? '#5e7ce2' : '#b8ada3',
                                }}
                              >
                                {checked && <span className="text-white text-[10px]">‚úì</span>}
                              </button>
                            </td>
                          );
                        })}
                        <td className="text-right">
                          <button onClick={() => setHabits(habits.filter(h => h.id !== habit.id))} className="text-[10px] text-[#b8ada3] px-1">‚úï</button>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>

              {/* Shrunken Add Form */}
              <div className="mt-2 flex gap-1">
                <input type="text" value={newEmoji} onChange={(e) => setNewEmoji(e.target.value)} className="w-7 p-1 text-center border rounded bg-transparent text-xs" />
                <input type="text" value={newHabit} onChange={(e) => setNewHabit(e.target.value)} placeholder="New..." className="flex-1 p-1 text-xs border rounded bg-transparent" />
                <button onClick={() => {
                   if (newHabit.trim()) {
                    setHabits([...habits, { id: Date.now(), name: newHabit.trim(), emoji: newEmoji, goal: 7 }]);
                    setNewHabit('');
                  }
                }} className="px-2 py-1 text-white text-[10px] rounded bg-[#7d8ba8]">+ Add</button>
              </div>
            </div>

            {/* Compact Stats Cards */}
            <div className="grid grid-cols-2 gap-2">
              <div className="rounded p-2" style={{background: '#e8e2dd'}}>
                <h2 className="text-[11px] font-bold mb-1 text-[#7d8ba8]">‚≠ê {getCurrentMonth()}</h2>
                {habits.slice(0, 3).map(h => (
                  <div key={h.id} className="text-[10px] flex justify-between opacity-80">
                    <span>{h.emoji} {h.name}</span>
                    <span>{monthlyStats[`${h.id}-${getCurrentMonth()}`] || 0}d</span>
                  </div>
                ))}
              </div>
              <div className="rounded p-2" style={{background: '#e8e2dd'}}>
                <h2 className="text-[11px] font-bold mb-1 text-[#7d8ba8]">üî• Streaks</h2>
                {habits.slice(0, 3).map(h => (
                  <div key={h.id} className="text-[10px] flex justify-between opacity-80">
                    <span>{h.emoji} {h.name}</span>
                    <span>{getStreak(h.id)}üî•</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }
    ReactDOM.render(<HabitTracker />, document.getElementById('root'));
  </script>
</body>
</html>
